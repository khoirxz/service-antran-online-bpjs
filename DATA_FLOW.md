# Data Flow Diagram - After Refactoring

## Single VisitEvent with task_progress

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Khanza Database (Read-only)                                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
     â”‚                                                        â”‚
     â”‚ fetchRegisterEvents()                  fetchTaskId(3/4/5)
     â”‚                                        â”‚
     v                                        v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pollers (run every 1 minute)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ REGISTER Poller â†’ CREATE VisitEvent                         â”‚
â”‚  â”œâ”€ visit_id                                               â”‚
â”‚  â”œâ”€ event_time                                             â”‚
â”‚  â”œâ”€ poli_id, dokter_id                                    â”‚
â”‚  â”œâ”€ status: READY_BPJS | BLOCKED_BPJS                    â”‚
â”‚  â”œâ”€ payload: { kuota, estimasi, ... }                    â”‚
â”‚  â””â”€ task_progress: {} (empty)                            â”‚
â”‚                                                              â”‚
â”‚ CHECKIN Poller â†’ UPDATE VisitEvent.task_progress           â”‚
â”‚  â””â”€ task_progress["3"] = { status: "DRAFT" }              â”‚
â”‚                                                              â”‚
â”‚ START Poller â†’ UPDATE VisitEvent.task_progress             â”‚
â”‚  â””â”€ task_progress["4"] = { status: "DRAFT" }              â”‚
â”‚                                                              â”‚
â”‚ FINISH Poller â†’ UPDATE VisitEvent.task_progress            â”‚
â”‚  â””â”€ task_progress["5"] = { status: "DRAFT" }              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
     â”‚                                                        â”‚
     v                                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VisitEvent Table (Single source of truth per visit)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ visit_id: "2026/01/20/001234"           â”‚ UNIQUE         â”‚
â”‚ event_time: 2026-01-20T08:00:00Z         â”‚                â”‚
â”‚ status: "READY_BPJS" | "SENT_BPJS" ... â”‚ REGISTER only  â”‚
â”‚ task_progress: {                         â”‚ JSON           â”‚
â”‚   "1": { status: "DRAFT" },             â”‚                â”‚
â”‚   "3": { status: "DRAFT" },             â”‚ Track all      â”‚
â”‚   "4": { status: "DRAFT" },             â”‚ task statuses  â”‚
â”‚   "5": { status: "DRAFT" }              â”‚                â”‚
â”‚ }                                        â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                                       â”‚                â”‚
                                       v                â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”
                          â”‚ Queue Builder (every 1 min)    â”‚
                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                          â”‚                               â”‚
                          â”‚ 1. Find READY_BPJS events   â”‚
                          â”‚    â†’ Create queue task_id=1 â”‚
                          â”‚                               â”‚
                          â”‚ 2. Check task_progress      â”‚
                          â”‚    â†’ Find task 3/4/5 DRAFT  â”‚
                          â”‚    â†’ Verify REGISTER SENT   â”‚
                          â”‚    â†’ Create queue task_id 3/4/5
                          â”‚                               â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BpjsAntreanQueue (PENDING jobs waiting to send)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id        â”‚ visit_id  â”‚ task_id      â”‚ status             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1001      â”‚ ...001234 â”‚ 1 (REGISTER) â”‚ PENDING â†’ SEND    â”‚
â”‚ 1002      â”‚ ...001234 â”‚ 3 (CHECKIN)  â”‚ PENDING â†’ SEND    â”‚
â”‚ 1003      â”‚ ...001234 â”‚ 4 (START)    â”‚ PENDING â†’ SEND    â”‚
â”‚ 1004      â”‚ ...001234 â”‚ 5 (FINISH)   â”‚ PENDING â†’ SEND    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          v
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Queue Worker (every 5 seconds)   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                   â”‚
        â”‚ 1. Pick PENDING job               â”‚
        â”‚ 2. Send to BPJS API               â”‚
        â”‚ 3. On success (code 200/208):    â”‚
        â”‚    - Update queue â†’ SEND         â”‚
        â”‚    - Update VisitEvent:          â”‚
        â”‚      task_progress[taskId] = {   â”‚
        â”‚        status: "SENT_BPJS",      â”‚
        â”‚        sentAt: now()             â”‚
        â”‚      }                            â”‚
        â”‚ 4. On failure:                    â”‚
        â”‚    - Retry up to 5x              â”‚
        â”‚    - On max retry:                â”‚
        â”‚      task_progress[taskId] = {   â”‚
        â”‚        status: "FAILED_BPJS",    â”‚
        â”‚        failedReason: error       â”‚
        â”‚      }                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VisitEvent (Updated with completion status)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ task_progress: {                                            â”‚
â”‚   "1": { status: "SENT_BPJS", sentAt: "..." },            â”‚
â”‚   "3": { status: "SENT_BPJS", sentAt: "..." },            â”‚
â”‚   "4": { status: "SENT_BPJS", sentAt: "..." },            â”‚
â”‚   "5": { status: "SENT_BPJS", sentAt: "..." }             â”‚
â”‚ }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          v
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ BpjsAntreanLogs (Audit)     â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ queue_id, request_payload,  â”‚
            â”‚ response_payload, http_code â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Improvements

1. **Single VisitEvent** - No duplicates, cleaner data structure
2. **JSON task_progress** - All task statuses in one place
3. **Simple Queries** - visit_id is UNIQUE, faster lookups
4. **Full Lifecycle** - One record tracks: REGISTER â†’ CHECKIN â†’ START â†’ FINISH
5. **Easy to Audit** - All changes in BpjsAntreanLogs linked to single visit

## Example Query

```typescript
// Get complete visit status
const visit = await prisma.visitEvent.findUnique({
  where: { visit_id: "2026/01/20/001234" },
});

console.log(visit.task_progress);
// Output:
// {
//   "1": { status: "SENT_BPJS", sentAt: "2026-01-20T10:00:00Z" },
//   "3": { status: "SENT_BPJS", sentAt: "2026-01-20T10:05:00Z" },
//   "4": { status: "FAILED_BPJS", failedReason: "Timeout" },
//   "5": { status: "DRAFT" }
// }
```

This shows that:

- REGISTER (1) sent successfully âœ…
- CHECKIN (3) sent successfully âœ…
- START (4) failed, need to retry âŒ
- FINISH (5) not yet processed ğŸ”„
