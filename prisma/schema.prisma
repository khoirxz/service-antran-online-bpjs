// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model PollingState {
  id              BigInt    @id @default(autoincrement())
  source          String    @unique @db.VarChar(50)
  last_event_time DateTime  @db.Timestamp(6)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @updatedAt
}

model VisitEvent {
  id         BigInt   @id @default(autoincrement())
  visit_id   String   @unique @db.VarChar(50) // no rawat
  event_time DateTime // Waktu REGISTER terjadi di sistem sumber

  // Dimensi Agregasi
  tanggal        DateTime // start of day
  jam_registrasi String   @db.VarChar(10) // HH:MM

  poli_id   String @db.VarChar(20)
  dokter_id String @db.VarChar(20)

  // Antrean 
  nomor_antrean String? @db.VarChar(20)
  angka_antrean Int?

  // Flag apakah pasien menggunakan JKN atau bukan
  is_jkn Boolean @default(false)

  // Status validasi terhadap HFIS BPJS untuk REGISTER
  status         VisitEventStatus @default(DRAFT)
  blocked_reason String?          @db.VarChar(255) // Alasan jika BLOCKED_BPJS
  payload        Json?

  // Track progress of tasks (CHECKIN=3, START=4, FINISH=5)
  // { "1": { status: "SENT_BPJS", sentAt: "..." }, "3": { status: "SENT_BPJS", sentAt: "..." }, ... }
  task_progress Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@index([event_time])
  @@index([tanggal, poli_id, dokter_id])
}

model BpjsAntreanQueue {
  id          BigInt    @id @default(autoincrement())
  visit_id    String    @db.VarChar(50) // no rawat
  task_id     Int
  event_time  DateTime
  payload     Json?
  status      Status    @default(PENDING)
  retry_count Int       @default(0)
  last_error  String?
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt

  @@unique([visit_id, task_id])
  @@index([status])
}

model BpjsAntreanLogs {
  id               BigInt    @id @default(autoincrement())
  queue_id         BigInt
  request_payload  Json
  response_payload Json
  http_code        Int
  createdAt        DateTime  @default(now())
  updatedAt        DateTime? @updatedAt

  @@index([queue_id])
}

model DoctorScheduleQuota {
  id BigInt @id @default(autoincrement())

  dokter_id   String @db.VarChar(20)
  poli_id     String @db.VarChar(20)
  nama_dokter String @db.VarChar(100)
  nama_poli   String @db.VarChar(100)

  tanggal DateTime // YYYY-MM-DD 00:00:00

  jam_mulai   String @db.VarChar(10) // HH:MM
  jam_selesai String @db.VarChar(10) // HH:MM

  kuota_jkn Int

  source    String // "BPJS HFIS"
  fetchedAt DateTime // Waktu data diambil dari sistem sumber

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@unique([poli_id, dokter_id, tanggal, jam_mulai])
  @@index([tanggal, poli_id, dokter_id])
}

model Poli {
  id                BigInt    @id @default(autoincrement())
  poli_id           String    @unique @db.VarChar(20)
  nama              String    @db.VarChar(100)
  kode_subspesialis String    @db.VarChar(20)
  nama_subspesialis String    @db.VarChar(100)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime? @updatedAt

  @@index([poli_id])
}

enum VisitEventStatus {
  DRAFT // Data belum lengkap
  READY_BPJS // Valid secara HFIS
  BLOCKED_BPJS // Invalid (kode dokter/poli tidak cocok)
  SENT_BPJS // Sudah dikirim ke BPJS
  FAILED_BPJS // Ditolak BPJS
}

enum Status {
  PENDING
  SEND
  FAILED
}
