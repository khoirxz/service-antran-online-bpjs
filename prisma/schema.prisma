// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model PollingState {
  id              BigInt    @id @default(autoincrement())
  source          String    @unique @db.VarChar(50)
  last_event_time DateTime  @db.Timestamp(6) // Last successfully processed event
  pending_cursor  String?   @db.VarChar(100) // Cursor untuk batch yang sedang diproses
  batch_count     Int       @default(0) // Jumlah batch yang telah diproses
  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @updatedAt
}

model VisitEvent {
  id         BigInt   @id @default(autoincrement())
  visit_id   String   @unique @db.VarChar(50) // no rawat
  event_time DateTime // Waktu REGISTER terjadi di sistem sumber

  // Dimensi Agregasi
  tanggal        DateTime // start of day
  jam_registrasi String   @db.VarChar(10) // HH:MM

  poli_id   String @db.VarChar(20)
  dokter_id String @db.VarChar(20)

  // Patient essential data - needed for BPJS submission
  // Nullable during migration, but should be populated
  no_rkm_medis String? @db.VarChar(50)

  // Antrean 
  nomor_antrean String? @db.VarChar(20)
  angka_antrean Int?

  // Flag apakah pasien menggunakan JKN atau bukan
  is_jkn Boolean @default(false)

  // Snapshot jadwal + kuota dari polling time
  // Contains: jam_praktek, kuota_jkn, sisa_kuota_jkn, kuota_nonjkn, sisa_kuota_nonjkn, estimasi_dilayani
  payload Json?

  // Track progress of all tasks (1=REGISTER, 3=CHECKIN, 4=START, 5=FINISH)
  // {
  //   "1": { status: "DRAFT" | "READY_BPJS" | "BLOCKED_BPJS" | "SENT_BPJS" | "FAILED_BPJS", blocked_reason?, sentAt?, failedReason? },
  //   "3": { status: "DRAFT" | "SENT_BPJS" | "FAILED_BPJS", sentAt?, failedReason? },
  //   "4": { status: "DRAFT" | "SENT_BPJS" | "FAILED_BPJS", sentAt?, failedReason? },
  //   "5": { status: "DRAFT" | "SENT_BPJS" | "FAILED_BPJS", sentAt?, failedReason? }
  // }
  task_progress Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@index([event_time])
  @@index([tanggal, poli_id, dokter_id])
}

model BpjsAntreanQueue {
  id          BigInt    @id @default(autoincrement())
  visit_id    String    @db.VarChar(50) // no rawat
  task_id     Int
  event_time  DateTime
  payload     Json?
  status      Status    @default(PENDING)
  retry_count Int       @default(0)
  last_error  String?
  sentAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt

  @@unique([visit_id, task_id])
  @@index([status])
}

model BpjsAntreanLogs {
  id               BigInt    @id @default(autoincrement())
  queue_id         BigInt
  request_payload  Json
  response_payload Json
  http_code        Int
  createdAt        DateTime  @default(now())
  updatedAt        DateTime? @updatedAt

  @@index([queue_id])
}

model DoctorScheduleQuota {
  id BigInt @id @default(autoincrement())

  dokter_id   String @db.VarChar(20)
  poli_id     String @db.VarChar(20)
  nama_dokter String @db.VarChar(100)
  nama_poli   String @db.VarChar(100)

  tanggal DateTime // YYYY-MM-DD 00:00:00

  jam_mulai   String @db.VarChar(10) // HH:MM
  jam_selesai String @db.VarChar(10) // HH:MM

  kuota_jkn Int

  source    String // "BPJS HFIS"
  fetchedAt DateTime // Waktu data diambil dari sistem sumber

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  @@unique([poli_id, dokter_id, tanggal, jam_mulai])
  @@index([tanggal, poli_id, dokter_id])
}

model Poli {
  id                BigInt    @id @default(autoincrement())
  poli_id           String    @unique @db.VarChar(20)
  nama              String    @db.VarChar(100)
  kode_subspesialis String    @db.VarChar(20)
  nama_subspesialis String    @db.VarChar(100)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime? @updatedAt

  @@index([poli_id])
}

model TaskValidationLog {
  id               BigInt    @id @default(autoincrement())
  visit_id         String    @db.VarChar(50) // no rawat
  expected_task_id Int? // Mana task yg diharapkan
  actual_task_id   Int? // Mana task yg diterima
  missing_task_id  Int? // Task mana yg hilang
  error_reason     String    @db.VarChar(100) // task_4_not_sent, task_3_missing, out_of_order, etc
  status           LogStatus @default(PENDING) // PENDING, RESOLVED, IGNORED
  detected_at      DateTime  @default(now())
  resolved_at      DateTime?
  notes            String?   @db.Text
  created_by       String?   @db.VarChar(50) // Staff ID / user yang perlu diingatkan
  createdAt        DateTime  @default(now())
  updatedAt        DateTime? @updatedAt

  @@index([visit_id])
  @@index([status])
  @@index([detected_at])
}

enum Status {
  PENDING
  SEND
  FAILED
}

enum LogStatus {
  PENDING
  RESOLVED
  IGNORED
}
